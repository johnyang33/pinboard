<!doctype html>
<html>
<head>
    <title>{{app_name}}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="static/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicons/favicon-16x16.png">
    <link rel="manifest" href="static/favicons/site.webmanifest">
</head>
<body>

{% macro render_tree(nodes) %}
<ul class="tree">
    {% for node in nodes %}
    <li class="{{ 'open' if node.active }} folder">
        {% if node.children %}
            <details id="folder-{{ node.path|replace('/', '-') }}"
         {% if node.active %}open{% endif %}>

                <summary>
                    {% if node.file_count > 0 %}
                        <a href="/gallery/{{ node.path }}">{{ node.name }}</a>
                    {% else %}
                        {{ node.name }}
                    {% endif %}

                   <span class="count">
                        {{ node.file_count }} files{% if node.folder_count %}, {{ node.folder_count }} folders{% endif %}
                    </span>
                    <span class="folder_size">
                        â€¢ {{ node.size }}
                    </span>
                    <button onclick="renameFolder('{{ node.path }}', '{{ node.name }}')">
                        <i class="fontello icon-pencil"></i>
                    </button>
                </summary>
                {{ render_tree(node.children) }}
            </details>
        {% else %}
            <div class="leaf-folder">
                <a href="/gallery/{{ node.path }}">
                    {{ node.name }}
                    (<span class="count">
                        {{ node.file_count }} files
                    </span>
                    <span class="folder_size">
                        {{ node.size }}
                    </span>)
                </a>
                <button onclick="renameFolder('{{ node.path }}', '{{ node.name }}')">
                    <i class="fontello icon-pencil"></i>
                </button>
                <button class="delete-folder"
                        onclick="deleteFolder('{{ node.path }}')">
                    <i class="fontello icon-trashcan"></i>
                </button>
            </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endmacro %}
           
<div  id="index_container" class="container">
    <main id="index">
        <div id="index_tree_wrapper">{{ render_tree(tree) }}</div>
    </main>
</div>

<script>
// Load open/closed state from localStorage
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("details").forEach(details => {
        const id = details.id;
        const state = localStorage.getItem(id);
        if (state === "open") {
            details.open = true;
        } else if (state === "closed") {
            details.open = false;
        }

        // Save state on toggle
        details.addEventListener("toggle", () => {
            localStorage.setItem(id, details.open ? "open" : "closed");
        });
    });
});
</script>
<script>
    document.getElementById("toggle-aside").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("collapsed");
});
</script>
<script>
function deleteFolder(path) {
    if (!confirm("Delete this folder? It must not contain subfolders.")) {
        return;
    }

    fetch("/folder/delete", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ path: path })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || "Error deleting folder");
        }
    });
}
</script>
<script>
function renameFolder(oldPath, currentName) {
    const newName = prompt("Enter new folder name:", currentName);

    if (!newName || newName.trim() === "" || newName === currentName) {
        return;
    }

    fetch("/folder/rename", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            old_path: oldPath,
            new_name: newName.trim()
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || "Error renaming folder");
        }
    });
}
</script>
</body>
</html>
