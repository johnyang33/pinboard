<!doctype html>
<html>
<head>
    <title>Pinz-{{ current_path }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="static/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicons/favicon-16x16.png">
    <link rel="manifest" href="static/favicons/site.webmanifest">
</head>
<body>
    <!-- MACRO: START -->
    {% macro render_tree(nodes) %}
    <ul class="tree">
        {% for node in nodes %}
        <li class="{{ 'open' if node.active }} folder">
            {% if node.children %}
                <details id="folder-{{ node.path|replace('/', '-') }}" {{ 'open' if node.active }}>
                    <summary>
                        {% if node.file_count > 0 %}
                            <a href="/gallery/{{ node.path }}">{{ node.name }}</a>
                        {% else %}
                            {{ node.name }}
                        {% endif %}

                        <span class="count">
                            ({{ node.file_count }} files{% if node.folder_count %}, {{ node.folder_count }} folders{% endif %})
                        </span>
                    </summary>
                    {{ render_tree(node.children) }}
                </details>
            {% else %}
                <a href="/gallery/{{ node.path }}">{{ node.name }}</a>
                <span class="count">
                    ({{ node.file_count }} files)
                </span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endmacro %}
    <!-- MACRO: END -->
<div class="container">
    <main>
        <aside id="sidebar" class="collapsed">
            <button id="toggle-aside" aria-label="Toggle sidebar">â˜°</button>
            <div class="navtree">    
                {{ render_tree(tree) }}
            </div>
        </aside>
        <nav id="content_bar">
            <ul style="list-style:none; padding:0; display:flex; gap:6px;">
                {% for crumb in breadcrumbs %}
                    <li>
                        {% if not loop.last %}
                            <a href="{{ crumb.url }}">{{ crumb.name }}</a> /
                        {% else %}
                            <strong>{{ crumb.name }}</strong>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>

            <div class="favorites_wrapper">
                <div class="showing">
                    {% if favorites_only %}
                        <p><strong>Currently only showing favorites</strong></p>
                    {% endif %}
                </div>
                <div class="showing">
                    {% if favorites_only %}
                        <a href="/gallery/{{ current_path }}"><i class="fontello icon-empty-heart"></i>Show all</a>
                    {% else %}
                        <a href="/gallery/{{ current_path }}?favorites=1"><i class="fontello icon-heart"></i>Show favorites only</a>
                    {% endif %}
                </div>

            </div>
        </nav>
        <div class="image_container">
            {% if images %}
                {% for img in images %}
                    <div class="media-item image">
                        <a href="{{ url_for('media_file', filename=img.path) }}">
                            <img src="{{ url_for('media_file', filename=img.path) }}">
                        </a>

                        <div class="caption">
                            <div class="file_name">{{ img.display_name }}</div>
                            <div class="actions">
                                <button class="fav-btn"
                                        data-path="{{ img.path }}"
                                        onclick="toggleFavorite(this)">
                                    
                                    {% if img.favorite %}
                                        <i class="fontello icon-heart"></i>
                                        {% else %}
                                        <i class="fontello icon-empty-heart"></i>
                                    {% endif %}
                                </button>
                                <button class="clear-rating"
                                    data-path="{{ img.path }}"
                                    onclick="clearRating(this)">
                                    <i class="fontello icon-cancel"></i>
                                </button>
                                <button class="rename-btn"
                                        data-path="{{ img.path }}"
                                        data-name="{{ img.name }}"
                                        onclick="renameMedia(this)">
                                    <i class="fontello icon-pencil"></i>
                                </button>
                                <button class="delete-btn"
                                    data-path="{{ img.path }}"
                                    onclick="deleteMedia(this)">
                                    <i class="fontello icon-trashcan"></i>
                                </button>
                            </div>
                        </div>
                        <div class="rating">
                            {% for i in range(1, 11) %}
                                <span class="star"
                                    data-path="{{ img.path }}"
                                    data-value="{{ i }}"
                                    onclick="setRating(this)">
                                    {% if i <= img.rating %}
                                        <i class="fontello icon-star"></i>
                                    {% else %}
                                        <i class="fontello icon-empty-star"></i>
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
            {% if videos %}
                {% for vid in videos %}
                    <div class="media-item video">
                        <video class="viddd" preload="metadata" controls loop>
                            <source src="{{ url_for('media_file', filename=vid.path) }}">
                        </video>

                        <div class="caption">
                            <div class="file_name">{{ vid.display_name }}</div>
                            <div class="actions">
                                <button class="fav-btn"
                                        data-path="{{ vid.path }}"
                                        onclick="toggleFavorite(this)">
                                    
                                    {% if vid.favorite %}
                                        <i class="fontello icon-heart"></i>
                                        {% else %}
                                        <i class="fontello icon-empty-heart"></i>
                                    {% endif %}
                                </button>
                                <button class="clear-rating"
                                    data-path="{{ vid.path }}"
                                    onclick="clearRating(this)">
                                    <i class="fontello icon-cancel"></i>
                                </button>
                                <button class="rename-btn"
                                        data-path="{{ vid.path }}"
                                        data-name="{{ vid.name }}"
                                        onclick="renameMedia(this)">
                                    <i class="fontello icon-pencil"></i>
                                </button>
                                <button class="delete-btn"
                                    data-path="{{ vid.path }}"
                                    onclick="deleteMedia(this)">
                                    <i class="fontello icon-trashcan"></i>
                                </button>
                            </div>
                        </div>
                        <div class="rating">
                            {% for i in range(1, 11) %}
                                <span class="star"
                                    data-path="{{ vid.path }}"
                                    data-value="{{ i }}"
                                    onclick="setRating(this)">
                                    {% if i <= vid.rating %}
                                        <i class="fontello icon-star"></i>
                                    {% else %}
                                        <i class="fontello icon-empty-star"></i>
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div><!-- images_container-->    
    </main>
</div><!-- container -->

<script>
    function toggleFavorite(btn) {
        const path = btn.dataset.path;

        fetch("/favorite/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path })
        })

        .then(r => r.json())
        .then(data => {
            const icon = btn.querySelector("i");

            icon.classList.toggle("icon-empty-heart", !data.favorite);
            icon.classList.toggle("icon-heart", data.favorite);
        });
    }

    function setRating(el) {
    const path = el.dataset.path;
    const rating = parseInt(el.dataset.value);

    fetch("/rating/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, rating })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert("Error setting rating");
            return;
        }

        // Get all stars for this image
        const stars = document.querySelectorAll(
            `.star[data-path="${path}"]`
        );

        stars.forEach(star => {
            const value = parseInt(star.dataset.value);
            const icon = star.querySelector("i");

            icon.classList.toggle("icon-star", value <= rating);
            icon.classList.toggle("icon-empty-star", value > rating);
        });
    });
}
</script>

<script>
function clearRating(btn) {
    const path = btn.dataset.path;

    fetch("/rating/set", {   // reuse existing endpoint
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, rating: 0 })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert("Error clearing rating");
            return;
        }

        // Select all stars for this image
        const stars = document.querySelectorAll(
            `.star[data-path="${path}"]`
        );

        stars.forEach(star => {
            const icon = star.querySelector("i");
            icon.classList.remove("icon-star");
            icon.classList.add("icon-empty-star");
        });
    });
}
</script>


<script>
    document.getElementById("toggle-aside").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("collapsed");
});
</script>
<script>
// Load open/closed state from localStorage
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("details").forEach(details => {
        const id = details.id;
        const state = localStorage.getItem(id);
        if (state === "open") {
            details.open = true;
        } else if (state === "closed") {
            details.open = false;
        }

        // Save state on toggle
        details.addEventListener("toggle", () => {
            localStorage.setItem(id, details.open ? "open" : "closed");
        });
    });
});
</script>
<script>
      // Set volume for all videos with a specific class
  document.querySelectorAll('.viddd').forEach(video => {
    video.volume = 0.05; // 50% volume
  });
</script>
<script>
function deleteMedia(btn) {
    const path = btn.dataset.path;

    if (!confirm("Are you sure you want to delete this file?")) {
        return;
    }

    fetch("/media/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Error: " + data.error);
        }
    });
}
</script>
<!-- <script>
function setRating(el) {
    const path = el.dataset.path;
    const rating = el.dataset.value;

    fetch("/rating/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path, rating })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Error setting rating");
        }
    });
}
</script> -->

<script>
function renameMedia(btn) {
    const oldPath = btn.dataset.path;
    const currentName = btn.dataset.name;

    const newName = prompt("Enter new file name:", currentName);
    if (!newName || newName === currentName) return;

    fetch("/media/rename", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            old_path: oldPath,
            new_name: newName
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Error: " + data.error);
        }
    });
}
</script>
</body>
</html>
